import { __assign, __decorate, __metadata, __param } from "tslib";
import { Inject, Injectable, LOCALE_ID, NgZone, Optional } from '@angular/core';
import { Observable, of, Subject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { GOOGLE_CHARTS_CONFIG } from '../models/injection-tokens.model';
import * as i0 from "@angular/core";
import * as i1 from "../models/injection-tokens.model";
import * as ɵngcc0 from '@angular/core';
var DEFAULT_CONFIG = {
    mapsApiKey: '',
    version: 'current',
    safeMode: false
};
var ScriptLoaderService = /** @class */ (function () {
    function ScriptLoaderService(zone, localeId, config) {
        this.zone = zone;
        this.localeId = localeId;
        this.config = config;
        this.scriptSource = 'https://www.gstatic.com/charts/loader.js';
        this.scriptLoadSubject = new Subject();
        this.config = __assign(__assign({}, DEFAULT_CONFIG), (config || {}));
    }
    /**
     * Checks whether `google.charts` is available.
     *
     * If not, it can be loaded by calling `loadChartPackages`.
     *
     * @returns `true` if `google.charts` is available, `false` otherwise.
     */
    ScriptLoaderService.prototype.isGoogleChartsAvailable = function () {
        if (typeof google === 'undefined' || typeof google.charts === 'undefined') {
            return false;
        }
        return true;
    };
    /**
     * Loads the Google Chart script and the provided chart packages.
     * Can be called multiple times to load more packages.
     *
     * When called without any arguments, this will just load the default package
     * containing the namespaces `google.charts` and `google.visualization` without any charts.
     *
     * @param packages The packages to load.
     * @returns A stream emitting as soon as the chart packages are loaded.
     */
    ScriptLoaderService.prototype.loadChartPackages = function () {
        var _this = this;
        var packages = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            packages[_i] = arguments[_i];
        }
        return this.loadGoogleCharts().pipe(switchMap(function () {
            return new Observable(function (observer) {
                var config = {
                    packages: packages,
                    language: _this.localeId,
                    mapsApiKey: _this.config.mapsApiKey,
                    safeMode: _this.config.safeMode
                };
                google.charts.load(_this.config.version, config);
                google.charts.setOnLoadCallback(function () {
                    _this.zone.run(function () {
                        observer.next();
                        observer.complete();
                    });
                });
            });
        }));
    };
    /**
     * Loads the Google Charts script. After the script is loaded, `google.charts` is defined.
     *
     * @returns A stream emitting as soon as loading has completed.
     * If the google charts script is already loaded, the stream emits immediately.
     */
    ScriptLoaderService.prototype.loadGoogleCharts = function () {
        var _this = this;
        if (this.isGoogleChartsAvailable()) {
            return of(null);
        }
        else if (!this.isLoadingGoogleCharts()) {
            var script = this.createGoogleChartsScript();
            script.onload = function () {
                _this.zone.run(function () {
                    _this.scriptLoadSubject.next();
                    _this.scriptLoadSubject.complete();
                });
            };
            script.onerror = function () {
                _this.zone.run(function () {
                    console.error('Failed to load the google charts script!');
                    _this.scriptLoadSubject.error(new Error('Failed to load the google charts script!'));
                });
            };
        }
        return this.scriptLoadSubject.asObservable();
    };
    ScriptLoaderService.prototype.isLoadingGoogleCharts = function () {
        return this.getGoogleChartsScript() != null;
    };
    ScriptLoaderService.prototype.getGoogleChartsScript = function () {
        var _this = this;
        var pageScripts = Array.from(document.getElementsByTagName('script'));
        return pageScripts.find(function (script) { return script.src === _this.scriptSource; });
    };
    ScriptLoaderService.prototype.createGoogleChartsScript = function () {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = this.scriptSource;
        script.async = true;
        document.getElementsByTagName('head')[0].appendChild(script);
        return script;
    };
    ScriptLoaderService.ctorParameters = function () { return [
        { type: NgZone },
        { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [GOOGLE_CHARTS_CONFIG,] }, { type: Optional }] }
    ]; };
    ScriptLoaderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ScriptLoaderService_Factory() { return new ScriptLoaderService(i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i0.LOCALE_ID), i0.ɵɵinject(i1.GOOGLE_CHARTS_CONFIG, 8)); }, token: ScriptLoaderService, providedIn: "root" });
    ScriptLoaderService = __decorate([ __param(1, Inject(LOCALE_ID)),
        __param(2, Inject(GOOGLE_CHARTS_CONFIG)), __param(2, Optional()),
        __metadata("design:paramtypes", [NgZone, String, Object])
    ], ScriptLoaderService);
ScriptLoaderService.ɵfac = function ScriptLoaderService_Factory(t) { return new (t || ScriptLoaderService)(ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(LOCALE_ID), ɵngcc0.ɵɵinject(GOOGLE_CHARTS_CONFIG, 8)); };
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ScriptLoaderService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: ɵngcc0.NgZone }, { type: String, decorators: [{
                type: Inject,
                args: [LOCALE_ID]
            }] }, { type: undefined, decorators: [{
                type: Inject,
                args: [GOOGLE_CHARTS_CONFIG]
            }, {
                type: Optional
            }] }]; }, null); })();
    return ScriptLoaderService;
}());
export { ScriptLoaderService };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0LWxvYWRlci5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyJuZzovYW5ndWxhci1nb29nbGUtY2hhcnRzL2xpYi9zY3JpcHQtbG9hZGVyL3NjcmlwdC1sb2FkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEYsT0FBTyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9DLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUczQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN4RTtBQUNvQzs7QUFBcEMsSUFBTSxjQUFjLEdBQXVCO0FBQzNDLElBQUUsVUFBVSxFQUFFLEVBQUU7QUFDaEIsSUFBRSxPQUFPLEVBQUUsU0FBUztBQUNwQixJQUFFLFFBQVEsRUFBRSxLQUFLO0FBQ2pCLENBQUMsQ0FBQztBQUdGO0FBQ29CLElBR2xCLDZCQUNVLElBQVksRUFDTyxRQUFnQixFQUNPLE1BQTJCO0FBQzlFLFFBSFMsU0FBSSxHQUFKLElBQUksQ0FBUTtBQUFDLFFBQ00sYUFBUSxHQUFSLFFBQVEsQ0FBUTtBQUFDLFFBQ00sV0FBTSxHQUFOLE1BQU0sQ0FBcUI7QUFDakYsUUFQbUIsaUJBQVksR0FBRywwQ0FBMEMsQ0FBQztBQUM3RSxRQUFtQixzQkFBaUIsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO0FBQzNELFFBTUksSUFBSSxDQUFDLE1BQU0seUJBQVEsY0FBYyxHQUFLLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQyxDQUFFLENBQUM7QUFDM0QsSUFBRSxDQUFDO0FBQ0gsSUFDRTtBQUNGO0FBQ0U7QUFDRTtBQUVIO0FBQU87QUFFSixPQURDO0FBQ0wsSUFBUyxxREFBdUIsR0FBOUI7QUFBYyxRQUNaLElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxJQUFJLE9BQU8sTUFBTSxDQUFDLE1BQU0sS0FBSyxXQUFXLEVBQUU7QUFDL0UsWUFBTSxPQUFPLEtBQUssQ0FBQztBQUNuQixTQUFLO0FBQ0wsUUFDSSxPQUFPLElBQUksQ0FBQztBQUNoQixJQUFFLENBQUM7QUFFSCxJQUFFO0FBQ0Y7QUFDRTtBQUNFO0FBQ0U7QUFDRTtBQUVIO0FBQU87QUFDRTtBQUVKLE9BREw7QUFDTCxJQUFTLCtDQUFpQixHQUF4QjtBQUFjLFFBQWQsaUJBcUJDO0FBQ0gsUUF0QjJCLGtCQUFxQjtBQUFDLGFBQXRCLFVBQXFCLEVBQXJCLHFCQUFxQixFQUFyQixJQUFxQjtBQUFJLFlBQXpCLDZCQUFxQjtBQUFDO0FBQVUsUUFDdkQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxJQUFJLENBQ2pDLFNBQVMsQ0FBQztBQUNWLFlBQUUsT0FBTyxJQUFJLFVBQVUsQ0FBTyxVQUFBLFFBQVE7QUFBSSxnQkFDdEMsSUFBTSxNQUFNLEdBQUc7QUFDekIsb0JBQVksUUFBUSxVQUFBO0FBQ3BCLG9CQUFZLFFBQVEsRUFBRSxLQUFJLENBQUMsUUFBUTtBQUNuQyxvQkFBWSxVQUFVLEVBQUUsS0FBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVO0FBQzlDLG9CQUFZLFFBQVEsRUFBRSxLQUFJLENBQUMsTUFBTSxDQUFDLFFBQVE7QUFDMUMsaUJBQVcsQ0FBQztBQUNaLGdCQUNVLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQzFELGdCQUFVLE1BQU0sQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUM7QUFDcEMsb0JBQU0sS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7QUFDcEIsd0JBQVEsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQzlCLHdCQUFjLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUNsQyxvQkFBWSxDQUFDLENBQUMsQ0FBQztBQUNmLGdCQUFVLENBQUMsQ0FBQyxDQUFDO0FBQ2IsWUFBUSxDQUFDLENBQUMsQ0FBQztBQUNYLFFBQU0sQ0FBQyxDQUFDLENBQ0gsQ0FBQztBQUNOLElBQUUsQ0FBQztBQUVILElBQUU7QUFDRjtBQUNFO0FBQ0U7QUFDRTtBQUVKLE9BREc7QUFDTCxJQUFVLDhDQUFnQixHQUF4QjtBQUFjLFFBQWQsaUJBcUJDO0FBQ0gsUUFyQkksSUFBSSxJQUFJLENBQUMsdUJBQXVCLEVBQUUsRUFBRTtBQUN4QyxZQUFNLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3RCLFNBQUs7QUFBQyxhQUFLLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsRUFBRTtBQUM5QyxZQUFNLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO0FBQ3JELFlBQU0sTUFBTSxDQUFDLE1BQU0sR0FBRztBQUNoQixnQkFBRSxLQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztBQUNoQixvQkFBSSxLQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDeEMsb0JBQVUsS0FBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQzVDLGdCQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ1gsWUFBTSxDQUFDLENBQUM7QUFDUixZQUNNLE1BQU0sQ0FBQyxPQUFPLEdBQUc7QUFDakIsZ0JBQUUsS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7QUFDaEIsb0JBQUksT0FBTyxDQUFDLEtBQUssQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0FBQ3BFLG9CQUFVLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQyxDQUFDO0FBQzlGLGdCQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ1gsWUFBTSxDQUFDLENBQUM7QUFDUixTQUFLO0FBQ0wsUUFDSSxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUNqRCxJQUFFLENBQUM7QUFFSCxJQUFVLG1EQUFxQixHQUE3QjtBQUFjLFFBQ1osT0FBTyxJQUFJLENBQUMscUJBQXFCLEVBQUUsSUFBSSxJQUFJLENBQUM7QUFDaEQsSUFBRSxDQUFDO0FBRUgsSUFBVSxtREFBcUIsR0FBN0I7QUFBYyxRQUFkLGlCQUdDO0FBQ0gsUUFISSxJQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQzVFLFFBQUksT0FBTyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsTUFBTSxDQUFDLEdBQUcsS0FBSyxLQUFJLENBQUMsWUFBWSxFQUFoQyxDQUFnQyxDQUFDLENBQUM7QUFDeEUsSUFBRSxDQUFDO0FBRUgsSUFBVSxzREFBd0IsR0FBaEM7QUFBYyxRQUNaLElBQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDcEQsUUFBSSxNQUFNLENBQUMsSUFBSSxHQUFHLGlCQUFpQixDQUFDO0FBQ3BDLFFBQUksTUFBTSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO0FBQ25DLFFBQUksTUFBTSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDeEIsUUFBSSxRQUFRLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ2pFLFFBQUksT0FBTyxNQUFNLENBQUM7QUFDbEIsSUFBRSxDQUFDO0FBQ0Y7QUFDOEQsZ0JBdEc3QyxNQUFNO0FBQ3RCLDZDQUFHLE1BQU0sU0FBQyxTQUFTO0FBQVMsZ0RBQ3pCLE1BQU0sU0FBQyxvQkFBb0IsY0FBRyxRQUFRO0FBQU07QUFBVTtBQVVHLElBakJqRCxtQkFBbUIsd0JBRC9CLFVBQVUsQ0FBQyxFQUFFLHRCQUNOLENBTUgsV0FBQSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUE7QUFQRSxFQUFFLE1BQU0sRUFBRSxDQUFDLFhBT1gsUUFDbkIsV0FBQSxNQUFNLENBQUMsb0JBQW9CLENBQUMsQ0FBQSxFQUFFLFdBQUEsUUFBUSxFQUFFLENBQUE7QUFBRSx5Q0FGN0IsTUFBTTtBQUNQLE9BTkosbUJBQW1CLENBMEcvQjs7Ozs7Ozs7Ozs7OztrQ0FDRDtBQUFDLDhCQXpIRDtBQUFFLENBd0hELEFBMUdELElBMEdDO0FBQ0QsU0EzR2EsbUJBQW1CO0FBQy9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBMT0NBTEVfSUQsIE5nWm9uZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEdvb2dsZUNoYXJ0c0NvbmZpZyB9IGZyb20gJy4uL21vZGVscy9nb29nbGUtY2hhcnRzLWNvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBHT09HTEVfQ0hBUlRTX0NPTkZJRyB9IGZyb20gJy4uL21vZGVscy9pbmplY3Rpb24tdG9rZW5zLm1vZGVsJztcblxuY29uc3QgREVGQVVMVF9DT05GSUc6IEdvb2dsZUNoYXJ0c0NvbmZpZyA9IHtcbiAgbWFwc0FwaUtleTogJycsXG4gIHZlcnNpb246ICdjdXJyZW50JyxcbiAgc2FmZU1vZGU6IGZhbHNlXG59O1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIFNjcmlwdExvYWRlclNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IHNjcmlwdFNvdXJjZSA9ICdodHRwczovL3d3dy5nc3RhdGljLmNvbS9jaGFydHMvbG9hZGVyLmpzJztcbiAgcHJpdmF0ZSByZWFkb25seSBzY3JpcHRMb2FkU3ViamVjdCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXG4gICAgQEluamVjdChMT0NBTEVfSUQpIHByaXZhdGUgbG9jYWxlSWQ6IHN0cmluZyxcbiAgICBASW5qZWN0KEdPT0dMRV9DSEFSVFNfQ09ORklHKSBAT3B0aW9uYWwoKSBwcml2YXRlIGNvbmZpZz86IEdvb2dsZUNoYXJ0c0NvbmZpZ1xuICApIHtcbiAgICB0aGlzLmNvbmZpZyA9IHsgLi4uREVGQVVMVF9DT05GSUcsIC4uLihjb25maWcgfHwge30pIH07XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIHdoZXRoZXIgYGdvb2dsZS5jaGFydHNgIGlzIGF2YWlsYWJsZS5cbiAgICpcbiAgICogSWYgbm90LCBpdCBjYW4gYmUgbG9hZGVkIGJ5IGNhbGxpbmcgYGxvYWRDaGFydFBhY2thZ2VzYC5cbiAgICpcbiAgICogQHJldHVybnMgYHRydWVgIGlmIGBnb29nbGUuY2hhcnRzYCBpcyBhdmFpbGFibGUsIGBmYWxzZWAgb3RoZXJ3aXNlLlxuICAgKi9cbiAgcHVibGljIGlzR29vZ2xlQ2hhcnRzQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xuICAgIGlmICh0eXBlb2YgZ29vZ2xlID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgZ29vZ2xlLmNoYXJ0cyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb2FkcyB0aGUgR29vZ2xlIENoYXJ0IHNjcmlwdCBhbmQgdGhlIHByb3ZpZGVkIGNoYXJ0IHBhY2thZ2VzLlxuICAgKiBDYW4gYmUgY2FsbGVkIG11bHRpcGxlIHRpbWVzIHRvIGxvYWQgbW9yZSBwYWNrYWdlcy5cbiAgICpcbiAgICogV2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgYXJndW1lbnRzLCB0aGlzIHdpbGwganVzdCBsb2FkIHRoZSBkZWZhdWx0IHBhY2thZ2VcbiAgICogY29udGFpbmluZyB0aGUgbmFtZXNwYWNlcyBgZ29vZ2xlLmNoYXJ0c2AgYW5kIGBnb29nbGUudmlzdWFsaXphdGlvbmAgd2l0aG91dCBhbnkgY2hhcnRzLlxuICAgKlxuICAgKiBAcGFyYW0gcGFja2FnZXMgVGhlIHBhY2thZ2VzIHRvIGxvYWQuXG4gICAqIEByZXR1cm5zIEEgc3RyZWFtIGVtaXR0aW5nIGFzIHNvb24gYXMgdGhlIGNoYXJ0IHBhY2thZ2VzIGFyZSBsb2FkZWQuXG4gICAqL1xuICBwdWJsaWMgbG9hZENoYXJ0UGFja2FnZXMoLi4ucGFja2FnZXM6IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMubG9hZEdvb2dsZUNoYXJ0cygpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8dm9pZD4ob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgICAgIHBhY2thZ2VzLFxuICAgICAgICAgICAgbGFuZ3VhZ2U6IHRoaXMubG9jYWxlSWQsXG4gICAgICAgICAgICBtYXBzQXBpS2V5OiB0aGlzLmNvbmZpZy5tYXBzQXBpS2V5LFxuICAgICAgICAgICAgc2FmZU1vZGU6IHRoaXMuY29uZmlnLnNhZmVNb2RlXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGdvb2dsZS5jaGFydHMubG9hZCh0aGlzLmNvbmZpZy52ZXJzaW9uLCBjb25maWcpO1xuICAgICAgICAgIGdvb2dsZS5jaGFydHMuc2V0T25Mb2FkQ2FsbGJhY2soKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoKTtcbiAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb2FkcyB0aGUgR29vZ2xlIENoYXJ0cyBzY3JpcHQuIEFmdGVyIHRoZSBzY3JpcHQgaXMgbG9hZGVkLCBgZ29vZ2xlLmNoYXJ0c2AgaXMgZGVmaW5lZC5cbiAgICpcbiAgICogQHJldHVybnMgQSBzdHJlYW0gZW1pdHRpbmcgYXMgc29vbiBhcyBsb2FkaW5nIGhhcyBjb21wbGV0ZWQuXG4gICAqIElmIHRoZSBnb29nbGUgY2hhcnRzIHNjcmlwdCBpcyBhbHJlYWR5IGxvYWRlZCwgdGhlIHN0cmVhbSBlbWl0cyBpbW1lZGlhdGVseS5cbiAgICovXG4gIHByaXZhdGUgbG9hZEdvb2dsZUNoYXJ0cygpIHtcbiAgICBpZiAodGhpcy5pc0dvb2dsZUNoYXJ0c0F2YWlsYWJsZSgpKSB7XG4gICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgfSBlbHNlIGlmICghdGhpcy5pc0xvYWRpbmdHb29nbGVDaGFydHMoKSkge1xuICAgICAgY29uc3Qgc2NyaXB0ID0gdGhpcy5jcmVhdGVHb29nbGVDaGFydHNTY3JpcHQoKTtcbiAgICAgIHNjcmlwdC5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2NyaXB0TG9hZFN1YmplY3QubmV4dCgpO1xuICAgICAgICAgIHRoaXMuc2NyaXB0TG9hZFN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICBzY3JpcHQub25lcnJvciA9ICgpID0+IHtcbiAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvYWQgdGhlIGdvb2dsZSBjaGFydHMgc2NyaXB0IScpO1xuICAgICAgICAgIHRoaXMuc2NyaXB0TG9hZFN1YmplY3QuZXJyb3IobmV3IEVycm9yKCdGYWlsZWQgdG8gbG9hZCB0aGUgZ29vZ2xlIGNoYXJ0cyBzY3JpcHQhJykpO1xuICAgICAgICB9KTtcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuc2NyaXB0TG9hZFN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwcml2YXRlIGlzTG9hZGluZ0dvb2dsZUNoYXJ0cygpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRHb29nbGVDaGFydHNTY3JpcHQoKSAhPSBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRHb29nbGVDaGFydHNTY3JpcHQoKTogSFRNTFNjcmlwdEVsZW1lbnQgfCBudWxsIHtcbiAgICBjb25zdCBwYWdlU2NyaXB0cyA9IEFycmF5LmZyb20oZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpKTtcbiAgICByZXR1cm4gcGFnZVNjcmlwdHMuZmluZChzY3JpcHQgPT4gc2NyaXB0LnNyYyA9PT0gdGhpcy5zY3JpcHRTb3VyY2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVHb29nbGVDaGFydHNTY3JpcHQoKTogSFRNTFNjcmlwdEVsZW1lbnQge1xuICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7XG4gICAgc2NyaXB0LnNyYyA9IHRoaXMuc2NyaXB0U291cmNlO1xuICAgIHNjcmlwdC5hc3luYyA9IHRydWU7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzY3JpcHQpO1xuICAgIHJldHVybiBzY3JpcHQ7XG4gIH1cbn1cbiJdfQ==