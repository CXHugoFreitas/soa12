import { __assign, __decorate, __metadata, __param, __read, __spread, __values } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, EventEmitter, Input, OnChanges, OnInit, Optional, Output, SimpleChanges } from '@angular/core';
import { fromEvent, ReplaySubject } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { ChartType } from '../../models/chart-type.model';
import { ScriptLoaderService } from '../../script-loader/script-loader.service';
import { DashboardComponent } from '../dashboard/dashboard.component';
import * as ɵngcc0 from '@angular/core';
var GoogleChartComponent = /** @class */ (function () {
    function GoogleChartComponent(element, scriptLoaderService, dashboard) {
        this.element = element;
        this.scriptLoaderService = scriptLoaderService;
        this.dashboard = dashboard;
        /**
         * The chart-specific options. All options listen in the Google Charts documentation applying
         * to the chart type specified can be used here.
         */
        this.options = {};
        /**
         * If this is set to `true`, the chart will be redrawn if the browser window is resized.
         * Defaults to `false` and should only be used when specifying the width or height of the chart
         * in percent.
         *
         * Note that this can impact performance.
         */
        this.dynamicResize = false;
        this.ready = new EventEmitter();
        this.error = new EventEmitter();
        this.select = new EventEmitter();
        this.mouseover = new EventEmitter();
        this.mouseleave = new EventEmitter();
        this.wrapperReadySubject = new ReplaySubject(1);
        this.initialized = false;
    }
    Object.defineProperty(GoogleChartComponent.prototype, "chart", {
        get: function () {
            if (!this.wrapper) {
                return null;
            }
            return this.wrapper.getChart();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GoogleChartComponent.prototype, "wrapperReady$", {
        get: function () {
            return this.wrapperReadySubject.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GoogleChartComponent.prototype, "chartWrapper", {
        get: function () {
            return this.wrapper;
        },
        set: function (wrapper) {
            this.wrapper = wrapper;
            this.drawChart();
        },
        enumerable: true,
        configurable: true
    });
    GoogleChartComponent.prototype.ngOnInit = function () {
        var _this = this;
        // We don't need to load any chart packages, the chart wrapper will handle this for us
        this.scriptLoaderService.loadChartPackages().subscribe(function () {
            _this.createDataTable();
            // Only ever create the wrapper once to allow animations to happen when someting changes.
            _this.wrapper = new google.visualization.ChartWrapper({
                container: _this.element.nativeElement,
                chartType: _this.type,
                dataTable: _this.dataTable,
                options: _this.mergeOptions()
            });
            _this.registerChartEvents();
            _this.wrapperReadySubject.next(_this.wrapper);
            _this.initialized = true;
            _this.drawChart();
        });
    };
    GoogleChartComponent.prototype.ngOnChanges = function (changes) {
        if (changes.dynamicResize) {
            this.updateResizeListener();
        }
        if (this.initialized) {
            var shouldRedraw = false;
            if (changes.data || changes.columns || changes.formatters) {
                this.createDataTable();
                this.wrapper.setDataTable(this.dataTable);
                shouldRedraw = true;
            }
            if (changes.type) {
                this.wrapper.setChartType(this.type);
                shouldRedraw = true;
            }
            if (changes.options || changes.width || changes.height || changes.title) {
                this.wrapper.setOptions(this.mergeOptions());
                shouldRedraw = true;
            }
            if (shouldRedraw) {
                this.drawChart();
            }
        }
    };
    GoogleChartComponent.prototype.createDataTable = function () {
        if (this.data == null) {
            return;
        }
        var firstRowIsData = true;
        if (this.columns != null) {
            firstRowIsData = false;
        }
        this.dataTable = google.visualization.arrayToDataTable(this.getDataAsTable(), firstRowIsData);
        this.applyFormatters(this.dataTable);
    };
    GoogleChartComponent.prototype.getDataAsTable = function () {
        if (this.columns) {
            return __spread([this.columns], this.data);
        }
        else {
            return this.data;
        }
    };
    GoogleChartComponent.prototype.updateResizeListener = function () {
        var _this = this;
        if (this.resizeSubscription != null) {
            this.resizeSubscription.unsubscribe();
            this.resizeSubscription = null;
        }
        if (this.dynamicResize) {
            this.resizeSubscription = fromEvent(window, 'resize')
                .pipe(debounceTime(100))
                .subscribe(function () {
                if (_this.initialized) {
                    _this.drawChart();
                }
            });
        }
    };
    GoogleChartComponent.prototype.mergeOptions = function () {
        return __assign({ title: this.title, width: this.width, height: this.height }, this.options);
    };
    GoogleChartComponent.prototype.applyFormatters = function (dataTable) {
        var e_1, _a;
        if (this.formatters == null) {
            return;
        }
        try {
            for (var _b = __values(this.formatters), _c = _b.next(); !_c.done; _c = _b.next()) {
                var val = _c.value;
                val.formatter.format(dataTable, val.colIndex);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    GoogleChartComponent.prototype.registerChartEvents = function () {
        var _this = this;
        google.visualization.events.removeAllListeners(this.wrapper);
        var registerChartEvent = function (object, eventName, callback) {
            google.visualization.events.addListener(object, eventName, callback);
        };
        registerChartEvent(this.wrapper, 'ready', function () {
            // This could also be done by checking if we already subscribed to the events
            google.visualization.events.removeAllListeners(_this.chart);
            registerChartEvent(_this.chart, 'onmouseover', function (event) { return _this.mouseover.emit(event); });
            registerChartEvent(_this.chart, 'onmouseout', function (event) { return _this.mouseleave.emit(event); });
            registerChartEvent(_this.chart, 'select', function () {
                var selection = _this.chart.getSelection();
                _this.select.emit({ selection: selection });
            });
            _this.ready.emit({ chart: _this.chart });
        });
        registerChartEvent(this.wrapper, 'error', function (error) { return _this.error.emit(error); });
    };
    GoogleChartComponent.prototype.drawChart = function () {
        if (this.dashboard != null) {
            // If this chart is part of a dashboard, the dashboard takes care of drawing
            return;
        }
        this.wrapper.draw();
    };
    GoogleChartComponent.ctorParameters = function () { return [
        { type: ElementRef },
        { type: ScriptLoaderService },
        { type: DashboardComponent, decorators: [{ type: Optional }] }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], GoogleChartComponent.prototype, "type", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], GoogleChartComponent.prototype, "data", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], GoogleChartComponent.prototype, "columns", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], GoogleChartComponent.prototype, "title", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], GoogleChartComponent.prototype, "width", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], GoogleChartComponent.prototype, "height", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], GoogleChartComponent.prototype, "options", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], GoogleChartComponent.prototype, "formatters", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], GoogleChartComponent.prototype, "dynamicResize", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], GoogleChartComponent.prototype, "ready", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], GoogleChartComponent.prototype, "error", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], GoogleChartComponent.prototype, "select", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], GoogleChartComponent.prototype, "mouseover", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], GoogleChartComponent.prototype, "mouseleave", void 0);
    GoogleChartComponent = __decorate([ __param(2, Optional()),
        __metadata("design:paramtypes", [ElementRef,
            ScriptLoaderService,
            DashboardComponent])
    ], GoogleChartComponent);
GoogleChartComponent.ɵfac = function GoogleChartComponent_Factory(t) { return new (t || GoogleChartComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ScriptLoaderService), ɵngcc0.ɵɵdirectiveInject(DashboardComponent, 8)); };
GoogleChartComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: GoogleChartComponent, selectors: [["google-chart"]], hostAttrs: [1, "google-chart"], inputs: { options: "options", dynamicResize: "dynamicResize", type: "type", data: "data", columns: "columns", title: "title", width: "width", height: "height", formatters: "formatters" }, outputs: { ready: "ready", error: "error", select: "select", mouseover: "mouseover", mouseleave: "mouseleave" }, exportAs: ["googleChart"], features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 0, vars: 0, template: function GoogleChartComponent_Template(rf, ctx) { }, styles: ["[_nghost-%COMP%] { width: fit-content; display: block; }"], changeDetection: 0 });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(GoogleChartComponent, [{
        type: Component,
        args: [{
                selector: 'google-chart',
                template: '',
                host: { class: 'google-chart' },
                exportAs: 'googleChart',
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [':host { width: fit-content; display: block; }']
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ScriptLoaderService }, { type: DashboardComponent, decorators: [{
                type: Optional
            }] }]; }, { options: [{
            type: Input
        }], dynamicResize: [{
            type: Input
        }], ready: [{
            type: Output
        }], error: [{
            type: Output
        }], select: [{
            type: Output
        }], mouseover: [{
            type: Output
        }], mouseleave: [{
            type: Output
        }], type: [{
            type: Input
        }], data: [{
            type: Input
        }], columns: [{
            type: Input
        }], title: [{
            type: Input
        }], width: [{
            type: Input
        }], height: [{
            type: Input
        }], formatters: [{
            type: Input
        }] }); })();
    return GoogleChartComponent;
}());
export { GoogleChartComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0LmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsibmc6L2FuZ3VsYXItZ29vZ2xlLWNoYXJ0cy9saWIvY29tcG9uZW50cy9nb29nbGUtY2hhcnQvZ29vZ2xlLWNoYXJ0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLHVCQUF1QixFQUN2QixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixRQUFRLEVBQ1IsTUFBTSxFQUNOLGFBQWEsRUFDZCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDOUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQVExRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUVoRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQzs7QUFldEU7QUFBd0QsSUFnR3RELDhCQUNVLE9BQW1CLEVBQ25CLG1CQUF3QyxFQUM1QixTQUE4QjtBQUNuRCxRQUhTLFlBQU8sR0FBUCxPQUFPLENBQVk7QUFBQyxRQUNwQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0FBQUMsUUFDN0IsY0FBUyxHQUFULFNBQVMsQ0FBcUI7QUFDdEQsUUFwREU7QUFDRjtBQUNNO0FBRUEsV0FERDtBQUNMLFFBQ1MsWUFBTyxHQUFXLEVBQUUsQ0FBQztBQUM5QixRQVVFO0FBQ0Y7QUFDTTtBQUNNO0FBRUM7QUFBVztBQUdYLFdBRlI7QUFDTCxRQUNTLGtCQUFhLEdBQUcsS0FBSyxDQUFDO0FBQy9CLFFBRVMsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFtQixDQUFDO0FBQ3JELFFBRVMsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFt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SXpELENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkF5UUY7QUFBQyxJQURELDJCQUFDO0FBQ0EsQ0FEQSxBQXZRRCxJQXVRQztBQUNELFNBeFFhLG9CQUFvQjtBQUFJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZXNcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIFJlcGxheVN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBDaGFydFR5cGUgfSBmcm9tICcuLi8uLi9tb2RlbHMvY2hhcnQtdHlwZS5tb2RlbCc7XG5pbXBvcnQge1xuICBDaGFydEVycm9yRXZlbnQsXG4gIENoYXJ0TW91c2VMZWF2ZUV2ZW50LFxuICBDaGFydE1vdXNlT3ZlckV2ZW50LFxuICBDaGFydFJlYWR5RXZlbnQsXG4gIENoYXJ0U2VsZWN0aW9uQ2hhbmdlZEV2ZW50XG59IGZyb20gJy4uLy4uL21vZGVscy9ldmVudHMubW9kZWwnO1xuaW1wb3J0IHsgU2NyaXB0TG9hZGVyU2VydmljZSB9IGZyb20gJy4uLy4uL3NjcmlwdC1sb2FkZXIvc2NyaXB0LWxvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IENoYXJ0QmFzZSwgQ29sdW1uLCBSb3cgfSBmcm9tICcuLi9jaGFydC1iYXNlL2NoYXJ0LWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IERhc2hib2FyZENvbXBvbmVudCB9IGZyb20gJy4uL2Rhc2hib2FyZC9kYXNoYm9hcmQuY29tcG9uZW50JztcblxuZXhwb3J0IGludGVyZmFjZSBGb3JtYXR0ZXIge1xuICBmb3JtYXR0ZXI6IGdvb2dsZS52aXN1YWxpemF0aW9uLkRlZmF1bHRGb3JtYXR0ZXI7XG4gIGNvbEluZGV4OiBudW1iZXI7XG59XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2dvb2dsZS1jaGFydCcsXG4gIHRlbXBsYXRlOiAnJyxcbiAgc3R5bGVzOiBbJzpob3N0IHsgd2lkdGg6IGZpdC1jb250ZW50OyBkaXNwbGF5OiBibG9jazsgfSddLFxuICBob3N0OiB7IGNsYXNzOiAnZ29vZ2xlLWNoYXJ0JyB9LFxuICBleHBvcnRBczogJ2dvb2dsZUNoYXJ0JyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcbn0pXG5leHBvcnQgY2xhc3MgR29vZ2xlQ2hhcnRDb21wb25lbnQgaW1wbGVtZW50cyBDaGFydEJhc2UsIE9uQ2hhbmdlcywgT25Jbml0IHtcbiAgLyoqXG4gICAqIFRoZSB0eXBlIG9mIHRoZSBjaGFydCB0byBjcmVhdGUuXG4gICAqL1xuICBASW5wdXQoKVxuICBwdWJsaWMgdHlwZSE6IENoYXJ0VHlwZTtcblxuICAvKipcbiAgICogRGF0YSB1c2VkIHRvIGluaXRpYWxpemUgdGhlIHRhYmxlLlxuICAgKlxuICAgKiBUaGlzIG11c3QgYWxzbyBjb250YWluIGFsbCByb2xlcyB0aGF0IGFyZSBzZXQgaW4gdGhlIGBjb2x1bW5zYCBwcm9wZXJ0eS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBkYXRhITogUm93W107XG5cbiAgLyoqXG4gICAqIFRoZSBjb2x1bW5zIHRoZSBgZGF0YWAgY29uc2lzdHMgb2YuXG4gICAqIFRoZSBsZW5ndGggb2YgdGhpcyBhcnJheSBtdXN0IG1hdGNoIHRoZSBsZW5ndGggb2YgZWFjaCByb3cgaW4gdGhlIGBkYXRhYCBvYmplY3QuXG4gICAqXG4gICAqIElmIHtAbGluayBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaGFydC9pbnRlcmFjdGl2ZS9kb2NzL3JvbGVzIHJvbGVzfSBzaG91bGQgYmUgYXBwbGllZCwgdGhleSBtdXN0IGJlIGluY2x1ZGVkIGluIHRoaXMgYXJyYXkgYXMgd2VsbC5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBjb2x1bW5zOiBDb2x1bW5bXTtcblxuICAvKipcbiAgICogQSBjb252ZW5pZW5jZSBwcm9wZXJ0eSB1c2VkIHRvIHNldCB0aGUgdGl0bGUgb2YgdGhlIGNoYXJ0LlxuICAgKlxuICAgKiBUaGlzIGNhbiBhbHNvIGJlIHNldCB1c2luZyBgb3B0aW9ucy50aXRsZWAsIHdoaWNoLCBpZiBleGlzdGFudCwgd2lsbCBvdmVyd3JpdGUgdGhpcyB2YWx1ZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyB0aXRsZT86IHN0cmluZztcblxuICAvKipcbiAgICogQSBjb252ZW5pZW5jZSBwcm9wZXJ0eSB1c2VkIHRvIHNldCB0aGUgd2lkdGggb2YgdGhlIGNoYXJ0IGluIHBpeGVscy5cbiAgICpcbiAgICogVGhpcyBjYW4gYWxzbyBiZSBzZXQgdXNpbmcgYG9wdGlvbnMud2lkdGhgLCB3aGljaCwgaWYgZXhpc3RhbnQsIHdpbGwgb3ZlcndyaXRlIHRoaXMgdmFsdWUuXG4gICAqL1xuICBASW5wdXQoKVxuICBwdWJsaWMgd2lkdGg/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEEgY29udmVuaWVuY2UgcHJvcGVydHkgdXNlZCB0byBzZXQgdGhlIGhlaWdodCBvZiB0aGUgY2hhcnQgaW4gcGl4ZWxzLlxuICAgKlxuICAgKiBUaGlzIGNhbiBhbHNvIGJlIHNldCB1c2luZyBgb3B0aW9ucy5oZWlnaHRgLCB3aGljaCwgaWYgZXhpc3RhbnQsIHdpbGwgb3ZlcndyaXRlIHRoaXMgdmFsdWUuXG4gICAqL1xuICBASW5wdXQoKVxuICBwdWJsaWMgaGVpZ2h0PzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgY2hhcnQtc3BlY2lmaWMgb3B0aW9ucy4gQWxsIG9wdGlvbnMgbGlzdGVuIGluIHRoZSBHb29nbGUgQ2hhcnRzIGRvY3VtZW50YXRpb24gYXBwbHlpbmdcbiAgICogdG8gdGhlIGNoYXJ0IHR5cGUgc3BlY2lmaWVkIGNhbiBiZSB1c2VkIGhlcmUuXG4gICAqL1xuICBASW5wdXQoKVxuICBwdWJsaWMgb3B0aW9uczogb2JqZWN0ID0ge307XG5cbiAgLyoqXG4gICAqIFVzZWQgdG8gY2hhbmdlIHRoZSBkaXNwbGF5ZWQgdmFsdWUgb2YgdGhlIHNwZWNpZmllZCBjb2x1bW4gaW4gYWxsIHJvd3MuXG4gICAqXG4gICAqIEVhY2ggYXJyYXkgZWxlbWVudCBtdXN0IGNvbnNpc3Qgb2YgYW4gaW5zdGFuY2Ugb2YgYSBbYGZvcm1hdHRlcmBdKGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2NoYXJ0L2ludGVyYWN0aXZlL2RvY3MvcmVmZXJlbmNlI2Zvcm1hdHRlcnMpXG4gICAqIGFuZCB0aGUgaW5kZXggb2YgdGhlIGNvbHVtbiB5b3Ugd2FudCB0aGUgZm9ybWF0dGVyIHRvIGdldCBhcHBsaWVkIHRvLlxuICAgKi9cbiAgQElucHV0KClcbiAgcHVibGljIGZvcm1hdHRlcnM/OiBGb3JtYXR0ZXJbXTtcblxuICAvKipcbiAgICogSWYgdGhpcyBpcyBzZXQgdG8gYHRydWVgLCB0aGUgY2hhcnQgd2lsbCBiZSByZWRyYXduIGlmIHRoZSBicm93c2VyIHdpbmRvdyBpcyByZXNpemVkLlxuICAgKiBEZWZhdWx0cyB0byBgZmFsc2VgIGFuZCBzaG91bGQgb25seSBiZSB1c2VkIHdoZW4gc3BlY2lmeWluZyB0aGUgd2lkdGggb3IgaGVpZ2h0IG9mIHRoZSBjaGFydFxuICAgKiBpbiBwZXJjZW50LlxuICAgKlxuICAgKiBOb3RlIHRoYXQgdGhpcyBjYW4gaW1wYWN0IHBlcmZvcm1hbmNlLlxuICAgKi9cbiAgQElucHV0KClcbiAgcHVibGljIGR5bmFtaWNSZXNpemUgPSBmYWxzZTtcblxuICBAT3V0cHV0KClcbiAgcHVibGljIHJlYWR5ID0gbmV3IEV2ZW50RW1pdHRlcjxDaGFydFJlYWR5RXZlbnQ+KCk7XG5cbiAgQE91dHB1dCgpXG4gIHB1YmxpYyBlcnJvciA9IG5ldyBFdmVudEVtaXR0ZXI8Q2hhcnRFcnJvckV2ZW50PigpO1xuXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgc2VsZWN0ID0gbmV3IEV2ZW50RW1pdHRlcjxDaGFydFNlbGVjdGlvbkNoYW5nZWRFdmVudD4oKTtcblxuICBAT3V0cHV0KClcbiAgcHVibGljIG1vdXNlb3ZlciA9IG5ldyBFdmVudEVtaXR0ZXI8Q2hhcnRNb3VzZU92ZXJFdmVudD4oKTtcblxuICBAT3V0cHV0KClcbiAgcHVibGljIG1vdXNlbGVhdmUgPSBuZXcgRXZlbnRFbWl0dGVyPENoYXJ0TW91c2VMZWF2ZUV2ZW50PigpO1xuXG4gIHByaXZhdGUgZGF0YVRhYmxlOiBnb29nbGUudmlzdWFsaXphdGlvbi5EYXRhVGFibGU7XG4gIHByaXZhdGUgcmVzaXplU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgcHJpdmF0ZSB3cmFwcGVyOiBnb29nbGUudmlzdWFsaXphdGlvbi5DaGFydFdyYXBwZXI7XG4gIHByaXZhdGUgd3JhcHBlclJlYWR5U3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0V3JhcHBlcj4oMSk7XG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBzY3JpcHRMb2FkZXJTZXJ2aWNlOiBTY3JpcHRMb2FkZXJTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZGFzaGJvYXJkPzogRGFzaGJvYXJkQ29tcG9uZW50XG4gICkge31cblxuICBwdWJsaWMgZ2V0IGNoYXJ0KCk6IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0QmFzZSB8IG51bGwge1xuICAgIGlmICghdGhpcy53cmFwcGVyKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy53cmFwcGVyLmdldENoYXJ0KCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHdyYXBwZXJSZWFkeSQoKSB7XG4gICAgcmV0dXJuIHRoaXMud3JhcHBlclJlYWR5U3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY2hhcnRXcmFwcGVyKCk6IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0V3JhcHBlciB7XG4gICAgcmV0dXJuIHRoaXMud3JhcHBlcjtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgY2hhcnRXcmFwcGVyKHdyYXBwZXI6IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0V3JhcHBlcikge1xuICAgIHRoaXMud3JhcHBlciA9IHdyYXBwZXI7XG4gICAgdGhpcy5kcmF3Q2hhcnQoKTtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uSW5pdCgpIHtcbiAgICAvLyBXZSBkb24ndCBuZWVkIHRvIGxvYWQgYW55IGNoYXJ0IHBhY2thZ2VzLCB0aGUgY2hhcnQgd3JhcHBlciB3aWxsIGhhbmRsZSB0aGlzIGZvciB1c1xuICAgIHRoaXMuc2NyaXB0TG9hZGVyU2VydmljZS5sb2FkQ2hhcnRQYWNrYWdlcygpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLmNyZWF0ZURhdGFUYWJsZSgpO1xuXG4gICAgICAvLyBPbmx5IGV2ZXIgY3JlYXRlIHRoZSB3cmFwcGVyIG9uY2UgdG8gYWxsb3cgYW5pbWF0aW9ucyB0byBoYXBwZW4gd2hlbiBzb21ldGluZyBjaGFuZ2VzLlxuICAgICAgdGhpcy53cmFwcGVyID0gbmV3IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0V3JhcHBlcih7XG4gICAgICAgIGNvbnRhaW5lcjogdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsXG4gICAgICAgIGNoYXJ0VHlwZTogdGhpcy50eXBlLFxuICAgICAgICBkYXRhVGFibGU6IHRoaXMuZGF0YVRhYmxlLFxuICAgICAgICBvcHRpb25zOiB0aGlzLm1lcmdlT3B0aW9ucygpXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5yZWdpc3RlckNoYXJ0RXZlbnRzKCk7XG5cbiAgICAgIHRoaXMud3JhcHBlclJlYWR5U3ViamVjdC5uZXh0KHRoaXMud3JhcHBlcik7XG4gICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcblxuICAgICAgdGhpcy5kcmF3Q2hhcnQoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMuZHluYW1pY1Jlc2l6ZSkge1xuICAgICAgdGhpcy51cGRhdGVSZXNpemVMaXN0ZW5lcigpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmluaXRpYWxpemVkKSB7XG4gICAgICBsZXQgc2hvdWxkUmVkcmF3ID0gZmFsc2U7XG4gICAgICBpZiAoY2hhbmdlcy5kYXRhIHx8IGNoYW5nZXMuY29sdW1ucyB8fCBjaGFuZ2VzLmZvcm1hdHRlcnMpIHtcbiAgICAgICAgdGhpcy5jcmVhdGVEYXRhVGFibGUoKTtcbiAgICAgICAgdGhpcy53cmFwcGVyLnNldERhdGFUYWJsZSh0aGlzLmRhdGFUYWJsZSk7XG4gICAgICAgIHNob3VsZFJlZHJhdyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChjaGFuZ2VzLnR5cGUpIHtcbiAgICAgICAgdGhpcy53cmFwcGVyLnNldENoYXJ0VHlwZSh0aGlzLnR5cGUpO1xuICAgICAgICBzaG91bGRSZWRyYXcgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2hhbmdlcy5vcHRpb25zIHx8IGNoYW5nZXMud2lkdGggfHwgY2hhbmdlcy5oZWlnaHQgfHwgY2hhbmdlcy50aXRsZSkge1xuICAgICAgICB0aGlzLndyYXBwZXIuc2V0T3B0aW9ucyh0aGlzLm1lcmdlT3B0aW9ucygpKTtcbiAgICAgICAgc2hvdWxkUmVkcmF3ID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKHNob3VsZFJlZHJhdykge1xuICAgICAgICB0aGlzLmRyYXdDaGFydCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRGF0YVRhYmxlKCkge1xuICAgIGlmICh0aGlzLmRhdGEgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBmaXJzdFJvd0lzRGF0YSA9IHRydWU7XG4gICAgaWYgKHRoaXMuY29sdW1ucyAhPSBudWxsKSB7XG4gICAgICBmaXJzdFJvd0lzRGF0YSA9IGZhbHNlO1xuICAgIH1cblxuICAgIHRoaXMuZGF0YVRhYmxlID0gZ29vZ2xlLnZpc3VhbGl6YXRpb24uYXJyYXlUb0RhdGFUYWJsZSh0aGlzLmdldERhdGFBc1RhYmxlKCksIGZpcnN0Um93SXNEYXRhKTtcbiAgICB0aGlzLmFwcGx5Rm9ybWF0dGVycyh0aGlzLmRhdGFUYWJsZSk7XG4gIH1cblxuICBwcml2YXRlIGdldERhdGFBc1RhYmxlKCk6IChSb3cgfCBDb2x1bW5bXSlbXSB7XG4gICAgaWYgKHRoaXMuY29sdW1ucykge1xuICAgICAgcmV0dXJuIFt0aGlzLmNvbHVtbnMsIC4uLnRoaXMuZGF0YV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmRhdGE7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVSZXNpemVMaXN0ZW5lcigpIHtcbiAgICBpZiAodGhpcy5yZXNpemVTdWJzY3JpcHRpb24gIT0gbnVsbCkge1xuICAgICAgdGhpcy5yZXNpemVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIHRoaXMucmVzaXplU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5keW5hbWljUmVzaXplKSB7XG4gICAgICB0aGlzLnJlc2l6ZVN1YnNjcmlwdGlvbiA9IGZyb21FdmVudCh3aW5kb3csICdyZXNpemUnKVxuICAgICAgICAucGlwZShkZWJvdW5jZVRpbWUoMTAwKSlcbiAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZHJhd0NoYXJ0KCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1lcmdlT3B0aW9ucygpOiBvYmplY3Qge1xuICAgIHJldHVybiB7XG4gICAgICB0aXRsZTogdGhpcy50aXRsZSxcbiAgICAgIHdpZHRoOiB0aGlzLndpZHRoLFxuICAgICAgaGVpZ2h0OiB0aGlzLmhlaWdodCxcbiAgICAgIC4uLnRoaXMub3B0aW9uc1xuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFwcGx5Rm9ybWF0dGVycyhkYXRhVGFibGU6IGdvb2dsZS52aXN1YWxpemF0aW9uLkRhdGFUYWJsZSk6IHZvaWQge1xuICAgIGlmICh0aGlzLmZvcm1hdHRlcnMgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgdmFsIG9mIHRoaXMuZm9ybWF0dGVycykge1xuICAgICAgdmFsLmZvcm1hdHRlci5mb3JtYXQoZGF0YVRhYmxlLCB2YWwuY29sSW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJDaGFydEV2ZW50cygpIHtcbiAgICBnb29nbGUudmlzdWFsaXphdGlvbi5ldmVudHMucmVtb3ZlQWxsTGlzdGVuZXJzKHRoaXMud3JhcHBlcik7XG5cbiAgICBjb25zdCByZWdpc3RlckNoYXJ0RXZlbnQgPSAob2JqZWN0OiBhbnksIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihvYmplY3QsIGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICAgIH07XG5cbiAgICByZWdpc3RlckNoYXJ0RXZlbnQodGhpcy53cmFwcGVyLCAncmVhZHknLCAoKSA9PiB7XG4gICAgICAvLyBUaGlzIGNvdWxkIGFsc28gYmUgZG9uZSBieSBjaGVja2luZyBpZiB3ZSBhbHJlYWR5IHN1YnNjcmliZWQgdG8gdGhlIGV2ZW50c1xuICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLnJlbW92ZUFsbExpc3RlbmVycyh0aGlzLmNoYXJ0KTtcbiAgICAgIHJlZ2lzdGVyQ2hhcnRFdmVudCh0aGlzLmNoYXJ0LCAnb25tb3VzZW92ZXInLCAoZXZlbnQ6IENoYXJ0TW91c2VPdmVyRXZlbnQpID0+IHRoaXMubW91c2VvdmVyLmVtaXQoZXZlbnQpKTtcbiAgICAgIHJlZ2lzdGVyQ2hhcnRFdmVudCh0aGlzLmNoYXJ0LCAnb25tb3VzZW91dCcsIChldmVudDogQ2hhcnRNb3VzZUxlYXZlRXZlbnQpID0+IHRoaXMubW91c2VsZWF2ZS5lbWl0KGV2ZW50KSk7XG4gICAgICByZWdpc3RlckNoYXJ0RXZlbnQodGhpcy5jaGFydCwgJ3NlbGVjdCcsICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gdGhpcy5jaGFydC5nZXRTZWxlY3Rpb24oKTtcbiAgICAgICAgdGhpcy5zZWxlY3QuZW1pdCh7IHNlbGVjdGlvbiB9KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnJlYWR5LmVtaXQoeyBjaGFydDogdGhpcy5jaGFydCB9KTtcbiAgICB9KTtcblxuICAgIHJlZ2lzdGVyQ2hhcnRFdmVudCh0aGlzLndyYXBwZXIsICdlcnJvcicsIChlcnJvcjogQ2hhcnRFcnJvckV2ZW50KSA9PiB0aGlzLmVycm9yLmVtaXQoZXJyb3IpKTtcbiAgfVxuXG4gIHByaXZhdGUgZHJhd0NoYXJ0KCkge1xuICAgIGlmICh0aGlzLmRhc2hib2FyZCAhPSBudWxsKSB7XG4gICAgICAvLyBJZiB0aGlzIGNoYXJ0IGlzIHBhcnQgb2YgYSBkYXNoYm9hcmQsIHRoZSBkYXNoYm9hcmQgdGFrZXMgY2FyZSBvZiBkcmF3aW5nXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy53cmFwcGVyLmRyYXcoKTtcbiAgfVxufVxuIl19