import { __decorate, __metadata, __param } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, EventEmitter, Input, OnChanges, OnInit, Optional, Output, SimpleChanges } from '@angular/core';
import { fromEvent, ReplaySubject } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { ChartType } from '../../models/chart-type.model';
import { ScriptLoaderService } from '../../script-loader/script-loader.service';
import { DashboardComponent } from '../dashboard/dashboard.component';
import * as ɵngcc0 from '@angular/core';
let GoogleChartComponent = class GoogleChartComponent {
    constructor(element, scriptLoaderService, dashboard) {
        this.element = element;
        this.scriptLoaderService = scriptLoaderService;
        this.dashboard = dashboard;
        /**
         * The chart-specific options. All options listen in the Google Charts documentation applying
         * to the chart type specified can be used here.
         */
        this.options = {};
        /**
         * If this is set to `true`, the chart will be redrawn if the browser window is resized.
         * Defaults to `false` and should only be used when specifying the width or height of the chart
         * in percent.
         *
         * Note that this can impact performance.
         */
        this.dynamicResize = false;
        this.ready = new EventEmitter();
        this.error = new EventEmitter();
        this.select = new EventEmitter();
        this.mouseover = new EventEmitter();
        this.mouseleave = new EventEmitter();
        this.wrapperReadySubject = new ReplaySubject(1);
        this.initialized = false;
    }
    get chart() {
        if (!this.wrapper) {
            return null;
        }
        return this.wrapper.getChart();
    }
    get wrapperReady$() {
        return this.wrapperReadySubject.asObservable();
    }
    get chartWrapper() {
        return this.wrapper;
    }
    set chartWrapper(wrapper) {
        this.wrapper = wrapper;
        this.drawChart();
    }
    ngOnInit() {
        // We don't need to load any chart packages, the chart wrapper will handle this for us
        this.scriptLoaderService.loadChartPackages().subscribe(() => {
            this.createDataTable();
            // Only ever create the wrapper once to allow animations to happen when someting changes.
            this.wrapper = new google.visualization.ChartWrapper({
                container: this.element.nativeElement,
                chartType: this.type,
                dataTable: this.dataTable,
                options: this.mergeOptions()
            });
            this.registerChartEvents();
            this.wrapperReadySubject.next(this.wrapper);
            this.initialized = true;
            this.drawChart();
        });
    }
    ngOnChanges(changes) {
        if (changes.dynamicResize) {
            this.updateResizeListener();
        }
        if (this.initialized) {
            let shouldRedraw = false;
            if (changes.data || changes.columns || changes.formatters) {
                this.createDataTable();
                this.wrapper.setDataTable(this.dataTable);
                shouldRedraw = true;
            }
            if (changes.type) {
                this.wrapper.setChartType(this.type);
                shouldRedraw = true;
            }
            if (changes.options || changes.width || changes.height || changes.title) {
                this.wrapper.setOptions(this.mergeOptions());
                shouldRedraw = true;
            }
            if (shouldRedraw) {
                this.drawChart();
            }
        }
    }
    createDataTable() {
        if (this.data == null) {
            return;
        }
        let firstRowIsData = true;
        if (this.columns != null) {
            firstRowIsData = false;
        }
        this.dataTable = google.visualization.arrayToDataTable(this.getDataAsTable(), firstRowIsData);
        this.applyFormatters(this.dataTable);
    }
    getDataAsTable() {
        if (this.columns) {
            return [this.columns, ...this.data];
        }
        else {
            return this.data;
        }
    }
    updateResizeListener() {
        if (this.resizeSubscription != null) {
            this.resizeSubscription.unsubscribe();
            this.resizeSubscription = null;
        }
        if (this.dynamicResize) {
            this.resizeSubscription = fromEvent(window, 'resize')
                .pipe(debounceTime(100))
                .subscribe(() => {
                if (this.initialized) {
                    this.drawChart();
                }
            });
        }
    }
    mergeOptions() {
        return Object.assign({ title: this.title, width: this.width, height: this.height }, this.options);
    }
    applyFormatters(dataTable) {
        if (this.formatters == null) {
            return;
        }
        for (const val of this.formatters) {
            val.formatter.format(dataTable, val.colIndex);
        }
    }
    registerChartEvents() {
        google.visualization.events.removeAllListeners(this.wrapper);
        const registerChartEvent = (object, eventName, callback) => {
            google.visualization.events.addListener(object, eventName, callback);
        };
        registerChartEvent(this.wrapper, 'ready', () => {
            // This could also be done by checking if we already subscribed to the events
            google.visualization.events.removeAllListeners(this.chart);
            registerChartEvent(this.chart, 'onmouseover', (event) => this.mouseover.emit(event));
            registerChartEvent(this.chart, 'onmouseout', (event) => this.mouseleave.emit(event));
            registerChartEvent(this.chart, 'select', () => {
                const selection = this.chart.getSelection();
                this.select.emit({ selection });
            });
            this.ready.emit({ chart: this.chart });
        });
        registerChartEvent(this.wrapper, 'error', (error) => this.error.emit(error));
    }
    drawChart() {
        if (this.dashboard != null) {
            // If this chart is part of a dashboard, the dashboard takes care of drawing
            return;
        }
        this.wrapper.draw();
    }
};
GoogleChartComponent.ɵfac = function GoogleChartComponent_Factory(t) { return new (t || GoogleChartComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ScriptLoaderService), ɵngcc0.ɵɵdirectiveInject(DashboardComponent, 8)); };
GoogleChartComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: GoogleChartComponent, selectors: [["google-chart"]], hostAttrs: [1, "google-chart"], inputs: { options: "options", dynamicResize: "dynamicResize", type: "type", data: "data", columns: "columns", title: "title", width: "width", height: "height", formatters: "formatters" }, outputs: { ready: "ready", error: "error", select: "select", mouseover: "mouseover", mouseleave: "mouseleave" }, exportAs: ["googleChart"], features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 0, vars: 0, template: function GoogleChartComponent_Template(rf, ctx) { }, styles: ["[_nghost-%COMP%] { width: fit-content; display: block; }"], changeDetection: 0 });
GoogleChartComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ScriptLoaderService },
    { type: DashboardComponent, decorators: [{ type: Optional }] }
];
__decorate([
    Input(),
    __metadata("design:type", String)
], GoogleChartComponent.prototype, "type", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], GoogleChartComponent.prototype, "data", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], GoogleChartComponent.prototype, "columns", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], GoogleChartComponent.prototype, "title", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], GoogleChartComponent.prototype, "width", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], GoogleChartComponent.prototype, "height", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "options", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array)
], GoogleChartComponent.prototype, "formatters", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "dynamicResize", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "ready", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "error", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "select", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "mouseover", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "mouseleave", void 0);
GoogleChartComponent = __decorate([ __param(2, Optional()),
    __metadata("design:paramtypes", [ElementRef,
        ScriptLoaderService,
        DashboardComponent])
], GoogleChartComponent);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(GoogleChartComponent, [{
        type: Component,
        args: [{
                selector: 'google-chart',
                template: '',
                host: { class: 'google-chart' },
                exportAs: 'googleChart',
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [':host { width: fit-content; display: block; }']
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ScriptLoaderService }, { type: DashboardComponent, decorators: [{
                type: Optional
            }] }]; }, { options: [{
            type: Input
        }], dynamicResize: [{
            type: Input
        }], ready: [{
            type: Output
        }], error: [{
            type: Output
        }], select: [{
            type: Output
        }], mouseover: [{
            type: Output
        }], mouseleave: [{
            type: Output
        }], type: [{
            type: Input
        }], data: [{
            type: Input
        }], columns: [{
            type: Input
        }], title: [{
            type: Input
        }], width: [{
            type: Input
        }], height: [{
            type: Input
        }], formatters: [{
            type: Input
        }] }); })();
export { GoogleChartComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0LmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsibmc6L2FuZ3VsYXItZ29vZ2xlLWNoYXJ0cy9saWIvY29tcG9uZW50cy9nb29nbGUtY2hhcnQvZ29vZ2xlLWNoYXJ0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLHVCQUF1QixFQUN2QixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixRQUFRLEVBQ1IsTUFBTSxFQUNOLGFBQWEsRUFDZCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDOUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQVExRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUVoRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQzs7QUFldEUsSUFBYSxvQkFBb0IsR0FBakMsTUFBYSxvQkFBb0I7QUFBRyxJQWdHbEMsWUFDVSxPQUFtQixFQUNuQixtQkFBd0MsRUFDNUIsU0FBOEI7QUFDbkQsUUFIUyxZQUFPLEdBQVAsT0FBTyxDQUFZO0FBQUMsUUFDcEIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtBQUFDLFFBQzdCLGNBQVMsR0FBVCxTQUFTLENBQXFCO0FBQ3RELFFBcERFO0FBQ0Y7QUFDTTtBQUVBLFdBREQ7QUFDTCxRQUNTLFlBQU8sR0FBVyxFQUFFLENBQUM7QUFDOUIsUUFVRTtBQUNGO0FBQ007QUFDTTtBQUVDO0FBQVc7QUFHWCxXQUZSO0FBQ0wsUUFDUyxrQkFBYSxHQUFHLEtBQUssQ0FBQztBQUMvQixRQUVTLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBbUIsQ0FBQztBQUNyRCxR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QjtBQVM1QjtBQUFhLElBRFosS0FBSyxFQUFFO0FBQ1Q7QUFFQyx3REFGZ0M7QUFVaEM7QUFBYSxJQURaLEtBQUssRUFBRTtBQUNUO0FBRUssMkRBRnlCO0FBRzdCO0FBQWEsSUFEWixNQUFNLEVBQUU7QUFDVjtBQUFzQyxtREFBYztBQUduRDtBQUFhLElBRFosTUFBTSxFQUFFO0FBQ1Y7QUFBc0MsbURBQWM7QUFHbkQ7QUFBYSxJQURaLE1BQU0sRUFBRTtBQUNWO0FBQXNDLG9EQUEwQjtBQUcvRDtBQUFhLElBRFosTUFBTSxFQUFFO0FBQ1Y7QUFBc0MsdURBQXNCO0FBRzNEO0FBQWEsSUFEWixNQUFNLEVBQUU7QUFDVjtBQUFzQyx3REFBd0I7QUF2RmxELG9CQUFvQixvQkFSaEMsU0FBUyxDQUFDLGZBUVAsQ0FtR0MsV0FBQSxRQUFRLEVBQUUsQ0FBQTtBQTFHYixRQUFRLEVBQUUsY0FBYyxVQUN4QixRQUFRLEVBQUUsRUFBRSw5Q0F5R0cscUNBRkksVUFBVTtPQXJHN0IsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLHRCQXNHakIsUUFBaUMsbUJBQW1CO09BdEdyQixFQUFFLFVBQy9CLFFBQVEsM0JBc0dWLFFBQW9DLGtCQUFrQjtBQXRHMUMsYUFBYSxVQUN2Qix2QkFzR0EsR0FwR1csb0JBQW9CLENBdVFoQztZQXpRZ0IsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNLG1CQUh0Qzs7TUFBK0MsT0FJekQsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBeVFGO0FBQUMsU0F4UVksb0JBQW9CO0FBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uSW5pdCxcbiAgT3B0aW9uYWwsXG4gIE91dHB1dCxcbiAgU2ltcGxlQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb21FdmVudCwgUmVwbGF5U3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IENoYXJ0VHlwZSB9IGZyb20gJy4uLy4uL21vZGVscy9jaGFydC10eXBlLm1vZGVsJztcbmltcG9ydCB7XG4gIENoYXJ0RXJyb3JFdmVudCxcbiAgQ2hhcnRNb3VzZUxlYXZlRXZlbnQsXG4gIENoYXJ0TW91c2VPdmVyRXZlbnQsXG4gIENoYXJ0UmVhZHlFdmVudCxcbiAgQ2hhcnRTZWxlY3Rpb25DaGFuZ2VkRXZlbnRcbn0gZnJvbSAnLi4vLi4vbW9kZWxzL2V2ZW50cy5tb2RlbCc7XG5pbXBvcnQgeyBTY3JpcHRMb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2NyaXB0LWxvYWRlci9zY3JpcHQtbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2hhcnRCYXNlLCBDb2x1bW4sIFJvdyB9IGZyb20gJy4uL2NoYXJ0LWJhc2UvY2hhcnQtYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgRGFzaGJvYXJkQ29tcG9uZW50IH0gZnJvbSAnLi4vZGFzaGJvYXJkL2Rhc2hib2FyZC5jb21wb25lbnQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZvcm1hdHRlciB7XG4gIGZvcm1hdHRlcjogZ29vZ2xlLnZpc3VhbGl6YXRpb24uRGVmYXVsdEZvcm1hdHRlcjtcbiAgY29sSW5kZXg6IG51bWJlcjtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnZ29vZ2xlLWNoYXJ0JyxcbiAgdGVtcGxhdGU6ICcnLFxuICBzdHlsZXM6IFsnOmhvc3QgeyB3aWR0aDogZml0LWNvbnRlbnQ7IGRpc3BsYXk6IGJsb2NrOyB9J10sXG4gIGhvc3Q6IHsgY2xhc3M6ICdnb29nbGUtY2hhcnQnIH0sXG4gIGV4cG9ydEFzOiAnZ29vZ2xlQ2hhcnQnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxufSlcbmV4cG9ydCBjbGFzcyBHb29nbGVDaGFydENvbXBvbmVudCBpbXBsZW1lbnRzIENoYXJ0QmFzZSwgT25DaGFuZ2VzLCBPbkluaXQge1xuICAvKipcbiAgICogVGhlIHR5cGUgb2YgdGhlIGNoYXJ0IHRvIGNyZWF0ZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyB0eXBlITogQ2hhcnRUeXBlO1xuXG4gIC8qKlxuICAgKiBEYXRhIHVzZWQgdG8gaW5pdGlhbGl6ZSB0aGUgdGFibGUuXG4gICAqXG4gICAqIFRoaXMgbXVzdCBhbHNvIGNvbnRhaW4gYWxsIHJvbGVzIHRoYXQgYXJlIHNldCBpbiB0aGUgYGNvbHVtbnNgIHByb3BlcnR5LlxuICAgKi9cbiAgQElucHV0KClcbiAgcHVibGljIGRhdGEhOiBSb3dbXTtcblxuICAvKipcbiAgICogVGhlIGNvbHVtbnMgdGhlIGBkYXRhYCBjb25zaXN0cyBvZi5cbiAgICogVGhlIGxlbmd0aCBvZiB0aGlzIGFycmF5IG11c3QgbWF0Y2ggdGhlIGxlbmd0aCBvZiBlYWNoIHJvdyBpbiB0aGUgYGRhdGFgIG9iamVjdC5cbiAgICpcbiAgICogSWYge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2NoYXJ0L2ludGVyYWN0aXZlL2RvY3Mvcm9sZXMgcm9sZXN9IHNob3VsZCBiZSBhcHBsaWVkLCB0aGV5IG11c3QgYmUgaW5jbHVkZWQgaW4gdGhpcyBhcnJheSBhcyB3ZWxsLlxuICAgKi9cbiAgQElucHV0KClcbiAgcHVibGljIGNvbHVtbnM6IENvbHVtbltdO1xuXG4gIC8qKlxuICAgKiBBIGNvbnZlbmllbmNlIHByb3BlcnR5IHVzZWQgdG8gc2V0IHRoZSB0aXRsZSBvZiB0aGUgY2hhcnQuXG4gICAqXG4gICAqIFRoaXMgY2FuIGFsc28gYmUgc2V0IHVzaW5nIGBvcHRpb25zLnRpdGxlYCwgd2hpY2gsIGlmIGV4aXN0YW50LCB3aWxsIG92ZXJ3cml0ZSB0aGlzIHZhbHVlLlxuICAgKi9cbiAgQElucHV0KClcbiAgcHVibGljIHRpdGxlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBIGNvbnZlbmllbmNlIHByb3BlcnR5IHVzZWQgdG8gc2V0IHRoZSB3aWR0aCBvZiB0aGUgY2hhcnQgaW4gcGl4ZWxzLlxuICAgKlxuICAgKiBUaGlzIGNhbiBhbHNvIGJlIHNldCB1c2luZyBgb3B0aW9ucy53aWR0aGAsIHdoaWNoLCBpZiBleGlzdGFudCwgd2lsbCBvdmVyd3JpdGUgdGhpcyB2YWx1ZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyB3aWR0aD86IG51bWJlcjtcblxuICAvKipcbiAgICogQSBjb252ZW5pZW5jZSBwcm9wZXJ0eSB1c2VkIHRvIHNldCB0aGUgaGVpZ2h0IG9mIHRoZSBjaGFydCBpbiBwaXhlbHMuXG4gICAqXG4gICAqIFRoaXMgY2FuIGFsc28gYmUgc2V0IHVzaW5nIGBvcHRpb25zLmhlaWdodGAsIHdoaWNoLCBpZiBleGlzdGFudCwgd2lsbCBvdmVyd3JpdGUgdGhpcyB2YWx1ZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBoZWlnaHQ/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBjaGFydC1zcGVjaWZpYyBvcHRpb25zLiBBbGwgb3B0aW9ucyBsaXN0ZW4gaW4gdGhlIEdvb2dsZSBDaGFydHMgZG9jdW1lbnRhdGlvbiBhcHBseWluZ1xuICAgKiB0byB0aGUgY2hhcnQgdHlwZSBzcGVjaWZpZWQgY2FuIGJlIHVzZWQgaGVyZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBvcHRpb25zOiBvYmplY3QgPSB7fTtcblxuICAvKipcbiAgICogVXNlZCB0byBjaGFuZ2UgdGhlIGRpc3BsYXllZCB2YWx1ZSBvZiB0aGUgc3BlY2lmaWVkIGNvbHVtbiBpbiBhbGwgcm93cy5cbiAgICpcbiAgICogRWFjaCBhcnJheSBlbGVtZW50IG11c3QgY29uc2lzdCBvZiBhbiBpbnN0YW5jZSBvZiBhIFtgZm9ybWF0dGVyYF0oaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hhcnQvaW50ZXJhY3RpdmUvZG9jcy9yZWZlcmVuY2UjZm9ybWF0dGVycylcbiAgICogYW5kIHRoZSBpbmRleCBvZiB0aGUgY29sdW1uIHlvdSB3YW50IHRoZSBmb3JtYXR0ZXIgdG8gZ2V0IGFwcGxpZWQgdG8uXG4gICAqL1xuICBASW5wdXQoKVxuICBwdWJsaWMgZm9ybWF0dGVycz86IEZvcm1hdHRlcltdO1xuXG4gIC8qKlxuICAgKiBJZiB0aGlzIGlzIHNldCB0byBgdHJ1ZWAsIHRoZSBjaGFydCB3aWxsIGJlIHJlZHJhd24gaWYgdGhlIGJyb3dzZXIgd2luZG93IGlzIHJlc2l6ZWQuXG4gICAqIERlZmF1bHRzIHRvIGBmYWxzZWAgYW5kIHNob3VsZCBvbmx5IGJlIHVzZWQgd2hlbiBzcGVjaWZ5aW5nIHRoZSB3aWR0aCBvciBoZWlnaHQgb2YgdGhlIGNoYXJ0XG4gICAqIGluIHBlcmNlbnQuXG4gICAqXG4gICAqIE5vdGUgdGhhdCB0aGlzIGNhbiBpbXBhY3QgcGVyZm9ybWFuY2UuXG4gICAqL1xuICBASW5wdXQoKVxuICBwdWJsaWMgZHluYW1pY1Jlc2l6ZSA9IGZhbHNlO1xuXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgcmVhZHkgPSBuZXcgRXZlbnRFbWl0dGVyPENoYXJ0UmVhZHlFdmVudD4oKTtcblxuICBAT3V0cHV0KClcbiAgcHVibGljIGVycm9yID0gbmV3IEV2ZW50RW1pdHRlcjxDaGFydEVycm9yRXZlbnQ+KCk7XG5cbiAgQE91dHB1dCgpXG4gIHB1YmxpYyBzZWxlY3QgPSBuZXcgRXZlbnRFbWl0dGVyPENoYXJ0U2VsZWN0aW9uQ2hhbmdlZEV2ZW50PigpO1xuXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgbW91c2VvdmVyID0gbmV3IEV2ZW50RW1pdHRlcjxDaGFydE1vdXNlT3ZlckV2ZW50PigpO1xuXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgbW91c2VsZWF2ZSA9IG5ldyBFdmVudEVtaXR0ZXI8Q2hhcnRNb3VzZUxlYXZlRXZlbnQ+KCk7XG5cbiAgcHJpdmF0ZSBkYXRhVGFibGU6IGdvb2dsZS52aXN1YWxpemF0aW9uLkRhdGFUYWJsZTtcbiAgcHJpdmF0ZSByZXNpemVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBwcml2YXRlIHdyYXBwZXI6IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0V3JhcHBlcjtcbiAgcHJpdmF0ZSB3cmFwcGVyUmVhZHlTdWJqZWN0ID0gbmV3IFJlcGxheVN1YmplY3Q8Z29vZ2xlLnZpc3VhbGl6YXRpb24uQ2hhcnRXcmFwcGVyPigxKTtcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIHNjcmlwdExvYWRlclNlcnZpY2U6IFNjcmlwdExvYWRlclNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBkYXNoYm9hcmQ/OiBEYXNoYm9hcmRDb21wb25lbnRcbiAgKSB7fVxuXG4gIHB1YmxpYyBnZXQgY2hhcnQoKTogZ29vZ2xlLnZpc3VhbGl6YXRpb24uQ2hhcnRCYXNlIHwgbnVsbCB7XG4gICAgaWYgKCF0aGlzLndyYXBwZXIpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLndyYXBwZXIuZ2V0Q2hhcnQoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgd3JhcHBlclJlYWR5JCgpIHtcbiAgICByZXR1cm4gdGhpcy53cmFwcGVyUmVhZHlTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHVibGljIGdldCBjaGFydFdyYXBwZXIoKTogZ29vZ2xlLnZpc3VhbGl6YXRpb24uQ2hhcnRXcmFwcGVyIHtcbiAgICByZXR1cm4gdGhpcy53cmFwcGVyO1xuICB9XG5cbiAgcHVibGljIHNldCBjaGFydFdyYXBwZXIod3JhcHBlcjogZ29vZ2xlLnZpc3VhbGl6YXRpb24uQ2hhcnRXcmFwcGVyKSB7XG4gICAgdGhpcy53cmFwcGVyID0gd3JhcHBlcjtcbiAgICB0aGlzLmRyYXdDaGFydCgpO1xuICB9XG5cbiAgcHVibGljIG5nT25Jbml0KCkge1xuICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gbG9hZCBhbnkgY2hhcnQgcGFja2FnZXMsIHRoZSBjaGFydCB3cmFwcGVyIHdpbGwgaGFuZGxlIHRoaXMgZm9yIHVzXG4gICAgdGhpcy5zY3JpcHRMb2FkZXJTZXJ2aWNlLmxvYWRDaGFydFBhY2thZ2VzKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuY3JlYXRlRGF0YVRhYmxlKCk7XG5cbiAgICAgIC8vIE9ubHkgZXZlciBjcmVhdGUgdGhlIHdyYXBwZXIgb25jZSB0byBhbGxvdyBhbmltYXRpb25zIHRvIGhhcHBlbiB3aGVuIHNvbWV0aW5nIGNoYW5nZXMuXG4gICAgICB0aGlzLndyYXBwZXIgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uQ2hhcnRXcmFwcGVyKHtcbiAgICAgICAgY29udGFpbmVyOiB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCxcbiAgICAgICAgY2hhcnRUeXBlOiB0aGlzLnR5cGUsXG4gICAgICAgIGRhdGFUYWJsZTogdGhpcy5kYXRhVGFibGUsXG4gICAgICAgIG9wdGlvbnM6IHRoaXMubWVyZ2VPcHRpb25zKClcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnJlZ2lzdGVyQ2hhcnRFdmVudHMoKTtcblxuICAgICAgdGhpcy53cmFwcGVyUmVhZHlTdWJqZWN0Lm5leHQodGhpcy53cmFwcGVyKTtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuXG4gICAgICB0aGlzLmRyYXdDaGFydCgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5keW5hbWljUmVzaXplKSB7XG4gICAgICB0aGlzLnVwZGF0ZVJlc2l6ZUxpc3RlbmVyKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIGxldCBzaG91bGRSZWRyYXcgPSBmYWxzZTtcbiAgICAgIGlmIChjaGFuZ2VzLmRhdGEgfHwgY2hhbmdlcy5jb2x1bW5zIHx8IGNoYW5nZXMuZm9ybWF0dGVycykge1xuICAgICAgICB0aGlzLmNyZWF0ZURhdGFUYWJsZSgpO1xuICAgICAgICB0aGlzLndyYXBwZXIuc2V0RGF0YVRhYmxlKHRoaXMuZGF0YVRhYmxlKTtcbiAgICAgICAgc2hvdWxkUmVkcmF3ID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNoYW5nZXMudHlwZSkge1xuICAgICAgICB0aGlzLndyYXBwZXIuc2V0Q2hhcnRUeXBlKHRoaXMudHlwZSk7XG4gICAgICAgIHNob3VsZFJlZHJhdyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChjaGFuZ2VzLm9wdGlvbnMgfHwgY2hhbmdlcy53aWR0aCB8fCBjaGFuZ2VzLmhlaWdodCB8fCBjaGFuZ2VzLnRpdGxlKSB7XG4gICAgICAgIHRoaXMud3JhcHBlci5zZXRPcHRpb25zKHRoaXMubWVyZ2VPcHRpb25zKCkpO1xuICAgICAgICBzaG91bGRSZWRyYXcgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoc2hvdWxkUmVkcmF3KSB7XG4gICAgICAgIHRoaXMuZHJhd0NoYXJ0KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVEYXRhVGFibGUoKSB7XG4gICAgaWYgKHRoaXMuZGF0YSA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IGZpcnN0Um93SXNEYXRhID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5jb2x1bW5zICE9IG51bGwpIHtcbiAgICAgIGZpcnN0Um93SXNEYXRhID0gZmFsc2U7XG4gICAgfVxuXG4gICAgdGhpcy5kYXRhVGFibGUgPSBnb29nbGUudmlzdWFsaXphdGlvbi5hcnJheVRvRGF0YVRhYmxlKHRoaXMuZ2V0RGF0YUFzVGFibGUoKSwgZmlyc3RSb3dJc0RhdGEpO1xuICAgIHRoaXMuYXBwbHlGb3JtYXR0ZXJzKHRoaXMuZGF0YVRhYmxlKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGF0YUFzVGFibGUoKTogKFJvdyB8IENvbHVtbltdKVtdIHtcbiAgICBpZiAodGhpcy5jb2x1bW5zKSB7XG4gICAgICByZXR1cm4gW3RoaXMuY29sdW1ucywgLi4udGhpcy5kYXRhXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVJlc2l6ZUxpc3RlbmVyKCkge1xuICAgIGlmICh0aGlzLnJlc2l6ZVN1YnNjcmlwdGlvbiAhPSBudWxsKSB7XG4gICAgICB0aGlzLnJlc2l6ZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy5yZXNpemVTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmR5bmFtaWNSZXNpemUpIHtcbiAgICAgIHRoaXMucmVzaXplU3Vic2NyaXB0aW9uID0gZnJvbUV2ZW50KHdpbmRvdywgJ3Jlc2l6ZScpXG4gICAgICAgIC5waXBlKGRlYm91bmNlVGltZSgxMDApKVxuICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhpcy5kcmF3Q2hhcnQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbWVyZ2VPcHRpb25zKCk6IG9iamVjdCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRpdGxlOiB0aGlzLnRpdGxlLFxuICAgICAgd2lkdGg6IHRoaXMud2lkdGgsXG4gICAgICBoZWlnaHQ6IHRoaXMuaGVpZ2h0LFxuICAgICAgLi4udGhpcy5vcHRpb25zXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlGb3JtYXR0ZXJzKGRhdGFUYWJsZTogZ29vZ2xlLnZpc3VhbGl6YXRpb24uRGF0YVRhYmxlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZm9ybWF0dGVycyA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCB2YWwgb2YgdGhpcy5mb3JtYXR0ZXJzKSB7XG4gICAgICB2YWwuZm9ybWF0dGVyLmZvcm1hdChkYXRhVGFibGUsIHZhbC5jb2xJbmRleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZWdpc3RlckNoYXJ0RXZlbnRzKCkge1xuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5yZW1vdmVBbGxMaXN0ZW5lcnModGhpcy53cmFwcGVyKTtcblxuICAgIGNvbnN0IHJlZ2lzdGVyQ2hhcnRFdmVudCA9IChvYmplY3Q6IGFueSwgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZExpc3RlbmVyKG9iamVjdCwgZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgfTtcblxuICAgIHJlZ2lzdGVyQ2hhcnRFdmVudCh0aGlzLndyYXBwZXIsICdyZWFkeScsICgpID0+IHtcbiAgICAgIC8vIFRoaXMgY291bGQgYWxzbyBiZSBkb25lIGJ5IGNoZWNraW5nIGlmIHdlIGFscmVhZHkgc3Vic2NyaWJlZCB0byB0aGUgZXZlbnRzXG4gICAgICBnb29nbGUudmlzdWFsaXphdGlvbi5ldmVudHMucmVtb3ZlQWxsTGlzdGVuZXJzKHRoaXMuY2hhcnQpO1xuICAgICAgcmVnaXN0ZXJDaGFydEV2ZW50KHRoaXMuY2hhcnQsICdvbm1vdXNlb3ZlcicsIChldmVudDogQ2hhcnRNb3VzZU92ZXJFdmVudCkgPT4gdGhpcy5tb3VzZW92ZXIuZW1pdChldmVudCkpO1xuICAgICAgcmVnaXN0ZXJDaGFydEV2ZW50KHRoaXMuY2hhcnQsICdvbm1vdXNlb3V0JywgKGV2ZW50OiBDaGFydE1vdXNlTGVhdmVFdmVudCkgPT4gdGhpcy5tb3VzZWxlYXZlLmVtaXQoZXZlbnQpKTtcbiAgICAgIHJlZ2lzdGVyQ2hhcnRFdmVudCh0aGlzLmNoYXJ0LCAnc2VsZWN0JywgKCkgPT4ge1xuICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSB0aGlzLmNoYXJ0LmdldFNlbGVjdGlvbigpO1xuICAgICAgICB0aGlzLnNlbGVjdC5lbWl0KHsgc2VsZWN0aW9uIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMucmVhZHkuZW1pdCh7IGNoYXJ0OiB0aGlzLmNoYXJ0IH0pO1xuICAgIH0pO1xuXG4gICAgcmVnaXN0ZXJDaGFydEV2ZW50KHRoaXMud3JhcHBlciwgJ2Vycm9yJywgKGVycm9yOiBDaGFydEVycm9yRXZlbnQpID0+IHRoaXMuZXJyb3IuZW1pdChlcnJvcikpO1xuICB9XG5cbiAgcHJpdmF0ZSBkcmF3Q2hhcnQoKSB7XG4gICAgaWYgKHRoaXMuZGFzaGJvYXJkICE9IG51bGwpIHtcbiAgICAgIC8vIElmIHRoaXMgY2hhcnQgaXMgcGFydCBvZiBhIGRhc2hib2FyZCwgdGhlIGRhc2hib2FyZCB0YWtlcyBjYXJlIG9mIGRyYXdpbmdcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLndyYXBwZXIuZHJhdygpO1xuICB9XG59XG4iXX0=